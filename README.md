# –î–æ–º–∞—à–Ω—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Ññ7: Apache Airflow

**–¢–µ–º–∞:** Apache Airflow - Orchestration —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è –ø—Ä–æ—Ü–µ—Å—ñ–≤ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö

## üìã –û–ø–∏—Å –∑–∞–≤–¥–∞–Ω–Ω—è

–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ DAG –≤ Apache Airflow, —è–∫–∏–π –≤–∏–∫–æ–Ω—É—î –Ω–∞—Å—Ç—É–ø–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è:
1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –º–µ–¥–∞–ª–µ–π
2. –í–∏–ø–∞–¥–∫–æ–≤–∏–π –≤–∏–±—ñ—Ä —Ç–∏–ø—É –º–µ–¥–∞–ª—ñ (Bronze, Silver, Gold)
3. –†–æ–∑–≥–∞–ª—É–∂–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –æ–±—Ä–∞–Ω–æ–≥–æ —Ç–∏–ø—É
4. –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –º–µ–¥–∞–ª–µ–π –æ–±—Ä–∞–Ω–æ–≥–æ —Ç–∏–ø—É –∑ Olympic Dataset
5. –ó–∞—Ç—Ä–∏–º–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
6. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ SQL Sensor

## üîß –¢–µ—Ö–Ω—ñ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ DAG

```python
DAG: rudenko_olympic_medals_dag
‚îú‚îÄ‚îÄ create_table (MySqlOperator)
‚îú‚îÄ‚îÄ pick_medal (PythonOperator)
‚îú‚îÄ‚îÄ pick_medal_task (BranchPythonOperator)
‚îú‚îÄ‚îÄ calc_Bronze / calc_Silver / calc_Gold (MySqlOperator)
‚îú‚îÄ‚îÄ generate_delay (PythonOperator)
‚îî‚îÄ‚îÄ check_for_correctness (SqlSensor)
```

### –û—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

#### 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
```sql
CREATE TABLE IF NOT EXISTS olympic_dataset.rudenko_medal_counts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    medal_type VARCHAR(10) NOT NULL,
    count INT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
)
```

#### 2. –í–∏–ø–∞–¥–∫–æ–≤–∏–π –≤–∏–±—ñ—Ä –º–µ–¥–∞–ª—ñ
–§—É–Ω–∫—Ü—ñ—è `pick_medal()` –≤–∏–ø–∞–¥–∫–æ–≤–æ –æ–±–∏—Ä–∞—î –æ–¥–∏–Ω –∑ —Ç—Ä—å–æ—Ö —Ç–∏–ø—ñ–≤ –º–µ–¥–∞–ª–µ–π:
- Bronze
- Silver  
- Gold

#### 3. –†–æ–∑–≥–∞–ª—É–∂–µ–Ω–Ω—è (Branching)
`BranchPythonOperator` –Ω–∞–ø—Ä–∞–≤–ª—è—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—ó –≥—ñ–ª–∫–∏ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –º–µ–¥–∞–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ –≤–∏–±–æ—Ä—É.

#### 4. –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –º–µ–¥–∞–ª–µ–π
–¢—Ä–∏ –æ–∫—Ä–µ–º—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –º–µ–¥–∞–ª–µ–π –∫–æ–∂–Ω–æ–≥–æ —Ç–∏–ø—É:
```sql
INSERT INTO olympic_dataset.rudenko_medal_counts (medal_type, count, created_at)
SELECT 'Bronze', COUNT(*), NOW()
FROM olympic_dataset.athlete_event_results
WHERE medal = 'Bronze';
```

#### 5. –ó–∞—Ç—Ä–∏–º–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –¥–≤–∞ —Ä–µ–∂–∏–º–∏:
- **–¢–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º:** 35 —Å–µ–∫—É–Ω–¥ (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó –ø—Ä–æ–≤–∞–ª—É —Å–µ–Ω—Å–æ—Ä–∞)
- **–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∏–π —Ä–µ–∂–∏–º:** 10 —Å–µ–∫—É–Ω–¥ (–¥–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è)

#### 6. SQL Sensor
–ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –Ω–∞–π–Ω–æ–≤—ñ—à–∏–π –∑–∞–ø–∏—Å —É —Ç–∞–±–ª–∏—Ü—ñ –Ω–µ —Å—Ç–∞—Ä—à–∏–π –∑–∞ 30 —Å–µ–∫—É–Ω–¥:
```sql
SELECT CASE 
    WHEN TIMESTAMPDIFF(SECOND, MAX(created_at), NOW()) <= 30
    THEN 1 ELSE 0 
END AS is_recent
FROM olympic_dataset.rudenko_medal_counts;
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

### –í–∏–∫–æ–Ω–∞–Ω–Ω—è DAG –≤ Airflow
![Airflow DAG Execution](airflow.png)

–ù–∞ —Å–∫—Ä—ñ–Ω—à–æ—Ç—ñ –≤–∏–¥–Ω–æ:
- ‚úÖ –£—Å–ø—ñ—à–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
- ‚úÖ –í–∏–ø–∞–¥–∫–æ–≤–∏–π –≤–∏–±—ñ—Ä –º–µ–¥–∞–ª—ñ
- ‚úÖ –†–æ–∑–≥–∞–ª—É–∂–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—ó –≥—ñ–ª–∫–∏ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É
- ‚úÖ –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞—Ç—Ä–∏–º–∫–∏
- üî¥ –ü—Ä–æ–≤–∞–ª —Å–µ–Ω—Å–æ—Ä–∞ –ø—Ä–∏ –∑–∞—Ç—Ä–∏–º—Ü—ñ > 30 —Å–µ–∫—É–Ω–¥ (—Ç–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º)
- ‚úÖ –£—Å–ø—ñ—à–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Å–µ–Ω—Å–æ—Ä–∞ –ø—Ä–∏ –∑–∞—Ç—Ä–∏–º—Ü—ñ 10 —Å–µ–∫—É–Ω–¥ (–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∏–π —Ä–µ–∂–∏–º)

### –î–∞–Ω—ñ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
![Database Records](db_data.png)

–°–∫—Ä—ñ–Ω—à–æ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—ñ `rudenko_medal_counts`:
- –†—ñ–∑–Ω—ñ —Ç–∏–ø–∏ –º–µ–¥–∞–ª–µ–π (Bronze, Silver, Gold)
- –ö—ñ–ª—å–∫—ñ—Å—Ç—å –º–µ–¥–∞–ª–µ–π –∫–æ–∂–Ω–æ–≥–æ —Ç–∏–ø—É
- –ß–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤

## üéØ –ö–ª—é—á–æ–≤—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è

1. **–î–∏–Ω–∞–º—ñ—á–Ω–µ —Ä–æ–∑–≥–∞–ª—É–∂–µ–Ω–Ω—è:** –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –º–µ—Ö–∞–Ω—ñ–∑–º –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ –≤–∏–±–æ—Ä—É —Ç–∞ —Ä–æ–∑–≥–∞–ª—É–∂–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è DAG
2. **–†–æ–±–æ—Ç–∞ –∑ MySQL:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ MySqlOperator –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å —Ç–∞ –∑–∞–ø–∏—Å—É –¥–∞–Ω–∏—Ö
3. **SQL Sensor:** –Ü–º–ø–ª–µ–º–µ–Ω—Ç–æ–≤–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö
4. **Trigger Rules:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ `NONE_FAILED_MIN_ONE_SUCCESS` –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –ø—ñ—Å–ª—è —Ä–æ–∑–≥–∞–ª—É–∂–µ–Ω–Ω—è
5. **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:** –ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–æ–≤–∞–Ω–æ —Ä–æ–±–æ—Ç—É —Å–µ–Ω—Å–æ—Ä–∞ –≤ —Ä—ñ–∑–Ω–∏—Ö —Ä–µ–∂–∏–º–∞—Ö (—É—Å–ø—ñ—Ö/–ø—Ä–æ–≤–∞–ª)

## üîê –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

```python
Connection ID: goit_mysql_db_rudenko
Host: 217.61.57.46
Schema: olympic_dataset
Login: neo_data_admin
Port: 3306
```

## üìù –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ DAG

- **Schedule:** Manual (schedule_interval=None)
- **Catchup:** False
- **Start Date:** 2024-11-26
- **Retries:** 1
- **Retry Delay:** 5 minutes

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

1. **–¢–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º (–∑ –ø—Ä–æ–≤–∞–ª–æ–º —Å–µ–Ω—Å–æ—Ä–∞):**
   - –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ `DELAY_SECONDS = 35`
   - –ó–∞–ø—É—Å—Ç–∏—Ç–∏ DAG
   - –°–µ–Ω—Å–æ—Ä –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è 30-—Å–µ–∫—É–Ω–¥–Ω–æ–≥–æ –ª—ñ–º—ñ—Ç—É

2. **–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∏–π —Ä–µ–∂–∏–º:**
   - –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ `DELAY_SECONDS = 10`
   - –ó–∞–ø—É—Å—Ç–∏—Ç–∏ DAG
   - –í—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞—é—Ç—å—Å—è —É—Å–ø—ñ—à–Ω–æ

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

```
hw-07-python-only/
‚îú‚îÄ‚îÄ rudenko_olympic_medals_dag.py  # –û—Å–Ω–æ–≤–Ω–∏–π DAG —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ README.md                       # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
‚îú‚îÄ‚îÄ airflow.png                     # –°–∫—Ä—ñ–Ω—à–æ—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è DAG
‚îî‚îÄ‚îÄ db_data.png                     # –°–∫—Ä—ñ–Ω—à–æ—Ç –¥–∞–Ω–∏—Ö –≤ –ë–î
```

## üîç –í–∏—Å–Ω–æ–≤–∫–∏

–ó–∞–≤–¥–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –≤–∏–∫–æ–Ω–∞–Ω–æ. –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –ø–æ–≤–Ω–æ—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π DAG, —è–∫–∏–π –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î:
- –†–æ–±–æ—Ç—É –∑ —Ä—ñ–∑–Ω–∏–º–∏ —Ç–∏–ø–∞–º–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ñ–≤ Airflow
- –î–∏–Ω–∞–º—ñ—á–Ω–µ —Ä–æ–∑–≥–∞–ª—É–∂–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
- –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –∑ MySQL –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å–µ–Ω—Å–æ—Ä—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —É–º–æ–≤
- –ü—Ä–∞–≤–∏–ª—å–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π –º—ñ–∂ –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏
